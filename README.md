# MLUONET - 企业级单据管理系统

## 项目概述

MLUONET是一个现代化的企业级单据管理系统，提供完整的报价单、采购单、发票、装箱单等业务单据的生成、管理和历史记录功能。

## 最新优化 (2025-08-01)

### 🚀 Dashboard性能优化
- **解决重复刷新问题**: 优化权限加载逻辑，避免首次登录时的两次刷新
- **优化退出逻辑**: 修复退出登录时的重复退出问题
- **权限缓存优化**: 添加首次加载标志，避免初始化时的权限变化事件
- **性能监控**: 添加详细的性能监控和优化指标

#### 优化详情
1. **权限Store优化**:
   - 添加 `isFirstLoad` 标志，避免首次加载时触发权限变化事件
   - 优化权限变化检测逻辑，只在真正需要时触发刷新
   - 改进缓存机制，减少不必要的API调用

2. **Dashboard页面优化**:
   - 优化初始化逻辑，避免重复权限获取
   - 改进权限变化监听，跳过首次加载时的刷新
   - 优化退出登录流程，避免重复调用signOut
   - 修复工具模块权限检查的依赖项问题

3. **Header组件优化**:
   - 调整退出登录顺序，先清理权限store再调用signOut
   - 避免重复的退出操作

#### 验证结果
- 解决了首次登录时的两次刷新问题
- 修复了退出登录时的重复退出问题
- 优化了工具模块的显示逻辑

### 🎯 客户信息管理优化
- **统一数据源**: 报价单页面的Load按钮现在直接从客户页面获取客户信息
- **智能匹配**: 支持从报价单、确认单、装箱单、发票等所有历史记录中提取客户信息
- **完整信息**: 自动提取客户的完整地址和联系信息
- **实时同步**: 保存的客户信息会立即同步到客户管理页面

#### 功能特性
1. **智能数据提取**:
   - 从客户相关的历史记录中自动提取客户信息
   - 支持多种单据类型（报价单、确认单、装箱单、发票）
   - **仅显示客户信息**：不包含供应商信息，确保数据分类清晰
   - **简洁显示**：Load列表中只显示客户名称的第一行，界面更简洁
   - 智能匹配客户名称，避免重复记录

2. **完整信息保存**:
   - 保存客户的完整地址和联系信息
   - 支持多行地址格式
   - 自动提取最新和最完整的客户信息

3. **统一管理**:
   - 客户信息在报价单和客户页面之间完全同步
   - 支持删除客户记录，会同时清理所有相关历史记录
   - 按最后更新时间排序，优先显示最新信息

#### 使用说明
- 在报价单页面的客户信息区域，点击"Load"按钮可以查看所有历史客户
- Load列表中只显示客户名称的第一行，点击后加载完整的客户信息
- 点击客户名称可以快速加载该客户的完整信息
- 点击"Save"按钮可以保存当前客户信息到历史记录
- 点击"Delete"按钮可以删除客户记录（会同时清理相关历史记录）

### 🏭 供应商信息管理优化
- **统一数据源**: 采购订单页面的Load按钮现在直接从客户页面的供应商tab获取供应商信息
- **智能匹配**: 支持从采购订单历史记录中提取供应商信息
- **完整信息**: 自动提取供应商的完整地址、报价号码和报价日期
- **实时同步**: 保存的供应商信息会立即同步到客户管理页面的供应商tab

#### 功能特性
1. **智能数据提取**:
   - 从采购订单历史记录中自动提取供应商信息
   - 支持供应商名称、报价号码、报价日期的完整信息
   - **简洁显示**：Load列表中只显示供应商名称的第一行，界面更简洁
   - 智能匹配供应商名称，避免重复记录

2. **完整信息保存**:
   - 保存供应商的完整地址和联系信息
   - 支持多行地址格式
   - 自动提取最新和最完整的供应商信息
   - 包含报价号码和报价日期信息

3. **统一管理**:
   - 供应商信息在采购订单和客户页面之间完全同步
   - 按最后更新时间排序，优先显示最新信息
   - 与客户信息管理保持一致的交互体验

#### 使用说明
- 在采购订单页面的供应商信息区域，点击"Load"按钮可以查看所有历史供应商
- Load列表中只显示供应商名称的第一行，点击后加载完整的供应商信息
- 点击供应商名称可以快速加载该供应商的完整信息
- 点击"Save"按钮可以保存当前供应商信息到历史记录
- 供应商信息会自动同步到客户页面的供应商tab中

## 主要功能

### 1. 个人主页 (Dashboard)
- **个性化欢迎**: 显示用户名称和当前日期
- **快速创建单据**: 提供报价单、发票、采购单、箱单的快速创建入口
- **最近文档**: 显示最近编辑的文档，支持快速访问
- **实用工具**: 集成AI邮件助手、日期计算等工具
- **管理功能**: 快速访问单据管理和客户管理
- **权限控制**: 根据用户权限动态显示可用功能
- **性能优化**: 使用缓存机制和预加载提升用户体验

#### Dashboard详细使用说明
- **页面布局**: 顶部导航栏、功能按钮区域、最近单据区域
- **功能按钮**: 分为快速创建单据、管理中心、实用工具三个类别
- **时间筛选**: 支持1天、3天、1周、1个月的时间范围筛选
- **权限控制**: 根据用户权限动态显示功能，无权限时显示友好提示
- **实时更新**: 单据创建或修改后自动更新列表，支持跨标签页同步
- **响应式设计**: 完美支持移动端和暗色模式

详细使用说明请参考：[Dashboard使用说明](./DASHBOARD_USAGE_GUIDE.md)

### 2. 单据管理中心 (History Management)
- **权限控制**: 根据用户在tools页面的权限设置，动态显示可访问的选项卡
- **多类型支持**: 支持报价单、合同确认、采购单、装箱单、发票等历史记录管理
- **高级过滤**: 支持按时间、金额、类型等多维度过滤
- **批量操作**: 支持批量删除、导出、导入功能
- **实时搜索**: 支持客户名称、单据编号等快速搜索

#### 权限控制机制
- 系统会根据用户在tools页面的权限设置，自动显示/隐藏对应的选项卡
- 权限映射关系：
  - `quotation` 权限 → 显示"报价单"和"合同确认"选项卡
  - `invoice` 权限 → 显示"发票"选项卡
  - `purchase` 权限 → 显示"采购单"选项卡
  - `packing` 权限 → 显示"装箱单"选项卡

#### 功能特性
- **智能切换**: 如果当前选项卡没有权限，会自动切换到第一个有权限的选项卡
- **权限验证**: 所有操作（编辑、删除、预览、复制等）都会验证用户权限
- **无权限提示**: 当用户没有任何权限时，显示友好的提示信息
- **加载状态**: 在获取用户权限时显示加载动画

### 3. 工具页面 (Tools)
- **模块化设计**: 每个功能模块独立，支持权限控制
- **动态加载**: 根据用户权限动态显示可用工具
- **性能优化**: 使用缓存机制提升加载速度

### 4. 单据生成功能
- **报价单**: 支持报价单和销售确认单的生成
- **采购单**: 完整的采购订单管理
- **发票**: 专业的发票生成和管理
- **装箱单**: 详细的装箱单和发票生成

## 技术架构

### 前端技术栈
- **Next.js 14**: 使用App Router架构
- **React 18**: 最新的React特性
- **TypeScript**: 完整的类型安全
- **Tailwind CSS**: 现代化的样式系统
- **Lucide React**: 图标库

### 后端技术栈
- **Next.js API Routes**: 服务端API
- **Prisma**: 数据库ORM
- **NextAuth.js**: 身份认证
- **PostgreSQL**: 数据库

### 性能优化
- **动态导入**: 使用dynamic import减少初始包大小
- **缓存机制**: 用户信息和权限缓存
- **懒加载**: 组件和资源的懒加载
- **性能监控**: 内置性能监控和优化
- **权限优化**: 智能权限加载，避免重复刷新
- **退出优化**: 优化退出登录流程，避免重复操作

## 权限系统

### 权限模型
```typescript
interface Permission {
  id: string;
  moduleId: string;
  canAccess: boolean;
}

interface User {
  id: string;
  username: string;
  email: string | null;
  status: boolean;
  isAdmin: boolean;
  permissions: Permission[];
}
```

### 权限管理系统
- **全局状态管理**: 使用 Zustand 进行权限状态管理
- **智能缓存**: 15分钟权限缓存，减少重复请求
- **权限守卫**: 提供 PermissionGuard 组件保护页面
- **权限检查**: 提供便捷的权限检查Hook

### 权限控制流程
1. **用户登录**: 获取用户信息和权限
2. **权限缓存**: 权限信息缓存15分钟，避免重复验证
3. **动态显示**: 根据权限动态显示/隐藏功能
4. **页面保护**: 使用 PermissionGuard 保护需要权限的页面
5. **实时更新**: 权限变更时自动更新界面

## 开发指南

### 环境设置
```bash
# 安装依赖
npm install

# 设置环境变量
cp .env.example .env.local

# 运行开发服务器
npm run dev
```

### 数据库设置
```bash
# 运行数据库迁移
npx prisma migrate dev

# 生成Prisma客户端
npx prisma generate
```

### 权限管理
- 通过管理员界面为用户分配权限
- 权限变更会实时反映在界面上
- 支持细粒度的模块权限控制

## 部署

### 生产环境
- 使用Vercel进行部署
- 配置环境变量
- 设置数据库连接

### 性能优化
- 启用CDN加速
- 配置缓存策略
- 监控应用性能

## 更新日志

### v1.0.0
- 实现基础的单据管理功能
- 添加权限控制系统
- 优化用户界面和用户体验
- 完善错误处理和日志记录

## 贡献指南

欢迎提交Issue和Pull Request来改进这个项目。

## 许可证

MIT License
