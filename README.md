# MLUONET - 企业级单据管理系统

## 项目概述

MLUONET是一个现代化的企业级单据管理系统，提供完整的报价单、采购单、发票、装箱单等业务单据的生成、管理和历史记录功能。

## 最新优化 (2025-08-01)

### 🔧 移除重复登录验证 (2025-08-01)
- **优化认证流程**: 移除了页面中重复的登录验证提示，因为中间件已经处理了认证
- **统一权限验证**: 优化了权限验证逻辑，只保留必要的权限加载状态
- **提升用户体验**: 减少了不必要的"验证登录中..."提示，让页面加载更流畅
- **简化代码逻辑**: 移除了重复的session状态检查，简化了页面初始化逻辑

#### 修复详情
1. **Dashboard页面优化**:
   - 移除了 `status === 'loading'` 的登录验证提示
   - 只保留权限加载时的状态提示
   - 简化了session检查逻辑

2. **Admin页面优化**:
   - 移除了重复的登录状态检查
   - 优化了权限验证流程
   - 简化了页面初始化逻辑

3. **Tools页面优化**:
   - 移除了不必要的登录验证
   - 只保留权限加载状态
   - 优化了页面加载体验

4. **Customer页面优化**:
   - 移除了重复的登录检查
   - 简化了页面初始化逻辑

5. **PermissionGuard组件优化**:
   - 移除了登录状态检查，因为中间件已经处理了认证
   - 只保留权限验证逻辑
   - 统一了权限验证的加载状态提示

#### 使用说明
- 页面加载时不再显示"验证登录中..."提示
- 只在权限加载时显示"加载权限中..."提示
- 页面跳转更加流畅，减少了不必要的验证步骤
- 中间件已经处理了所有认证逻辑，页面只需要处理权限验证

### 🔧 权限隔离问题修复 (2025-08-01)
- **修复权限数据污染问题**: 解决了管理员修改一个用户权限时影响其他用户权限的问题
- **用户特定权限缓存**: 为每个用户创建独立的权限缓存，避免权限数据互相影响
- **智能缓存管理**: 优化权限缓存清理逻辑，只清理当前用户的缓存
- **完整测试验证**: 添加权限隔离测试脚本，确保修复效果

#### 修复详情
1. **权限缓存隔离**:
   - 修改权限缓存键名，使用用户ID作为前缀
   - 每个用户有独立的权限备份和存储
   - 避免不同用户之间的权限数据互相影响

2. **缓存管理优化**:
   - 新增用户特定的权限缓存清理函数
   - 优化退出登录时的缓存清理逻辑
   - 智能处理权限备份的存储和恢复

3. **权限数据一致性**:
   - 确保每个用户的权限数据完全隔离
   - 管理员修改权限时只影响目标用户
   - 保持权限数据的准确性和安全性

#### 使用说明
- 管理员修改用户权限时，只会影响该用户的权限数据
- 每个用户有独立的权限缓存，不会互相影响
- 系统自动处理权限隔离，无需额外操作

### 🔧 用户信息管理页面修复 (2025-08-01)
- **修复数据格式问题**: 解决用户详情页面返回用户列表而不是单个用户数据的问题
- **智能数据解析**: 添加了处理不同API响应格式的逻辑
- **统一数据处理**: 创建了 `fetchUserData` 辅助函数，统一处理用户数据获取
- **错误处理优化**: 改进了错误处理逻辑，提供更清晰的错误信息

#### 修复详情
1. **API响应格式处理**:
   - 支持用户列表格式 `{ users: [...] }`
   - 支持单个用户格式 `{ id, username, ... }`
   - 自动检测和适配不同的API响应格式

2. **数据处理优化**:
   - 创建 `fetchUserData` 辅助函数统一处理用户数据获取
   - 简化了所有用户数据获取的代码逻辑
   - 改进了错误处理和调试日志

3. **功能验证**:
   - 添加了完整的测试用例验证修复效果
   - 确保用户信息管理页面的所有功能正常工作

#### 使用说明
- 用户信息管理页面现在可以正确处理API返回的数据
- 支持查看和编辑用户的基本信息（用户名、邮箱、密码）
- 支持管理用户的管理员权限和账户状态
- 支持配置用户的功能模块权限
- 支持删除用户账户

### 🔧 权限修改功能优化 (2025-08-01)
- **修复权限切换问题**: 改进了权限切换的UI响应和状态管理
- **增强调试功能**: 添加了详细的调试日志，便于问题诊断
- **优化API调用**: 改进了权限更新后的数据重新获取逻辑
- **改进错误处理**: 增强了权限修改过程中的错误处理机制

#### 修复详情
1. **权限状态管理优化**:
   - 改进了权限切换的状态更新逻辑
   - 添加了详细的调试日志，便于跟踪权限变化
   - 优化了权限变化检测机制

2. **API调用优化**:
   - 修复了权限更新后数据重新获取的逻辑
   - 改进了API响应的数据处理
   - 增强了认证信息的处理

3. **UI交互优化**:
   - 添加了权限切换的点击事件调试
   - 改进了保存按钮的响应逻辑
   - 优化了权限状态的实时显示

#### 功能验证
- 添加了完整的权限修改UI逻辑测试
- 验证了权限切换、状态管理和数据更新的正确性
- 确保权限修改功能在各种情况下都能正常工作

#### 使用说明
- 在用户信息管理页面，可以点击权限开关来切换用户的功能权限
- 权限变化会实时反映在UI上，并启用保存按钮
- 点击保存按钮会将权限更改提交到服务器
- 所有权限操作都有详细的调试日志，便于问题诊断

### 🔧 登录权限获取修复 (2025-08-01)
- **修复登录后权限丢失问题**: 解决了登录后用户权限数据为undefined的问题
- **改进权限初始化逻辑**: 优化了Dashboard页面的权限获取流程
- **增强调试功能**: 添加了详细的权限获取和检查日志
- **优化API调用**: 改进了权限API的调用和错误处理

#### 修复详情
1. **权限获取逻辑优化**:
   - 修复了登录后权限数据为undefined的问题
   - 改进了权限store的初始化逻辑
   - 添加了强制权限获取机制

2. **Dashboard页面优化**:
   - 改进了权限初始化检查逻辑
   - 添加了用户登录状态检查
   - 优化了权限数据获取的时机

3. **调试功能增强**:
   - 添加了详细的权限获取日志
   - 增加了API调用状态监控
   - 改进了错误处理和诊断信息

#### 问题诊断
通过调试日志发现的问题：
- 用户数据为undefined，导致所有权限检查失败
- 权限初始化已完成，但用户数据仍然为空
- API调用可能存在问题，需要进一步检查

#### 使用说明
- 登录后系统会自动获取用户权限
- 如果权限获取失败，可以尝试刷新页面
- 所有权限操作都有详细的调试日志，便于问题诊断
- 权限数据会自动缓存，提高页面加载速度

### 🔧 API认证修复 (2025-08-01)
- **修复API认证问题**: 改进了API调用的认证机制
- **增强token获取**: 支持多种方式获取NextAuth session token
- **改进错误处理**: 优化了API调用的错误处理和调试信息
- **添加调试日志**: 增加了详细的API调用状态监控

#### 修复详情
1. **认证机制优化**:
   - 支持从localStorage获取session token
   - 支持从cookies获取session token
   - 添加了CSRF token支持
   - 改进了Authorization头的设置

2. **API调用改进**:
   - 添加了详细的API调用日志
   - 改进了错误处理和状态监控
   - 优化了认证信息的获取逻辑

3. **调试功能增强**:
   - 添加了session状态检查
   - 增加了API调用状态监控
   - 改进了错误诊断信息

#### 问题诊断
通过调试发现的问题：
- NextAuth session token获取方式不正确
- API调用缺少正确的认证信息
- 需要支持多种token获取方式

#### 使用说明
- 系统现在支持多种认证方式
- API调用会自动尝试获取正确的认证信息
- 所有API调用都有详细的调试日志
- 认证失败时会提供详细的错误信息

### 🔧 CORS和认证修复 (2025-08-01)
- **修复CORS问题**: 解决了跨域请求时的CORS配置问题
- **改进认证机制**: 使用NextAuth session数据作为主要认证方式
- **优化API调用**: 改进了API调用的认证逻辑
- **增强错误处理**: 添加了更详细的错误诊断信息

#### 修复详情
1. **CORS问题修复**:
   - 修复了credentials模式下的CORS配置问题
   - 根据认证状态动态设置credentials选项
   - 改进了跨域请求的处理逻辑

2. **认证机制优化**:
   - 优先使用NextAuth session数据
   - 添加了多种token获取方式
   - 改进了认证信息的获取逻辑

3. **API调用改进**:
   - 添加了NextAuth session获取函数
   - 优化了权限数据的获取流程
   - 改进了错误处理和调试信息

#### 问题诊断
通过调试发现的问题：
- CORS配置不允许credentials模式下的通配符origin
- NextAuth session token获取方式不正确
- 需要优先使用NextAuth session数据而不是API调用

#### 使用说明
- 系统现在优先使用NextAuth session数据
- 解决了跨域请求的CORS问题
- 改进了认证信息的获取方式
- 所有API调用都有详细的调试日志

### 🔧 权限显示修复 (2025-08-01)
- **修复权限显示问题**: 解决了用户信息管理页面权限显示不准确的问题
- **改进权限初始化**: 为管理员用户添加默认权限设置
- **优化权限计算**: 改进了权限状态的计算和显示逻辑
- **增强调试功能**: 添加了详细的权限状态调试信息

#### 修复详情
1. **权限初始化优化**:
   - 为没有权限数据的用户添加默认权限设置
   - 管理员用户默认开启所有模块权限
   - 改进了权限数据的初始化逻辑

2. **权限显示改进**:
   - 修复了权限数量计算不准确的问题
   - 改进了权限状态的实时更新
   - 优化了权限切换的响应逻辑

3. **调试功能增强**:
   - 添加了详细的权限状态调试信息
   - 增加了权限切换的日志记录
   - 改进了权限数据的诊断功能

#### 问题诊断
通过调试发现的问题：
- 用户没有任何权限数据，导致显示0个模块启用
- 权限初始化逻辑没有处理空权限的情况
- 需要为管理员用户设置默认权限

#### 使用说明
- 管理员用户现在会默认开启所有模块权限
- 权限显示会实时反映权限状态的变化
- 所有权限操作都有详细的调试日志
- 权限数据会自动初始化，避免显示错误

### 🚀 Dashboard性能优化

### 🚀 Dashboard性能优化
- **解决重复刷新问题**: 优化权限加载逻辑，避免首次登录时的两次刷新
- **优化退出逻辑**: 修复退出登录时的重复退出问题
- **权限缓存优化**: 添加首次加载标志，避免初始化时的权限变化事件
- **性能监控**: 添加详细的性能监控和优化指标

#### 优化详情
1. **权限Store优化**:
   - 添加 `isFirstLoad` 标志，避免首次加载时触发权限变化事件
   - 优化权限变化检测逻辑，只在真正需要时触发刷新
   - 改进缓存机制，减少不必要的API调用

2. **Dashboard页面优化**:
   - 优化初始化逻辑，避免重复权限获取
   - 改进权限变化监听，跳过首次加载时的刷新
   - 优化退出登录流程，避免重复调用signOut
   - 修复工具模块权限检查的依赖项问题

3. **Header组件优化**:
   - 调整退出登录顺序，先清理权限store再调用signOut
   - 避免重复的退出操作

#### 验证结果
- 解决了首次登录时的两次刷新问题
- 修复了退出登录时的重复退出问题
- 优化了工具模块的显示逻辑

### 🎯 客户信息管理优化
- **统一数据源**: 报价单页面的Load按钮现在直接从客户页面获取客户信息
- **智能匹配**: 支持从报价单、确认单、装箱单、发票等所有历史记录中提取客户信息
- **完整信息**: 自动提取客户的完整地址和联系信息
- **实时同步**: 保存的客户信息会立即同步到客户管理页面

#### 功能特性
1. **智能数据提取**:
   - 从客户相关的历史记录中自动提取客户信息
   - 支持多种单据类型（报价单、确认单、装箱单、发票）
   - **仅显示客户信息**：不包含供应商信息，确保数据分类清晰
   - **简洁显示**：Load列表中只显示客户名称的第一行，界面更简洁
   - 智能匹配客户名称，避免重复记录

2. **完整信息保存**:
   - 保存客户的完整地址和联系信息
   - 支持多行地址格式
   - 自动提取最新和最完整的客户信息

3. **统一管理**:
   - 客户信息在报价单和客户页面之间完全同步
   - 支持删除客户记录，会同时清理所有相关历史记录
   - 按最后更新时间排序，优先显示最新信息

#### 使用说明
- 在报价单页面的客户信息区域，点击"Load"按钮可以查看所有历史客户
- Load列表中只显示客户名称的第一行，点击后加载完整的客户信息
- 点击客户名称可以快速加载该客户的完整信息
- 点击"Save"按钮可以保存当前客户信息到历史记录
- 点击"Delete"按钮可以删除客户记录（会同时清理相关历史记录）

### 🏭 供应商信息管理优化
- **统一数据源**: 采购订单页面的Load按钮现在直接从客户页面的供应商tab获取供应商信息
- **智能匹配**: 支持从采购订单历史记录中提取供应商信息
- **完整信息**: 自动提取供应商的完整地址、报价号码和报价日期
- **实时同步**: 保存的供应商信息会立即同步到客户管理页面的供应商tab

#### 功能特性
1. **智能数据提取**:
   - 从采购订单历史记录中自动提取供应商信息
   - 支持供应商名称、报价号码、报价日期的完整信息
   - **简洁显示**：Load列表中只显示供应商名称的第一行，界面更简洁
   - 智能匹配供应商名称，避免重复记录

2. **完整信息保存**:
   - 保存供应商的完整地址和联系信息
   - 支持多行地址格式
   - 自动提取最新和最完整的供应商信息
   - 包含报价号码和报价日期信息

3. **统一管理**:
   - 供应商信息在采购订单和客户页面之间完全同步
   - 按最后更新时间排序，优先显示最新信息
   - 与客户信息管理保持一致的交互体验

#### 使用说明
- 在采购订单页面的供应商信息区域，点击"Load"按钮可以查看所有历史供应商
- Load列表中只显示供应商名称的第一行，点击后加载完整的供应商信息
- 点击供应商名称可以快速加载该供应商的完整信息
- 点击"Save"按钮可以保存当前供应商信息到历史记录
- 供应商信息会自动同步到客户页面的供应商tab中

## 主要功能

### 1. 个人主页 (Dashboard)
- **个性化欢迎**: 显示用户名称和当前日期
- **快速创建单据**: 提供报价单、发票、采购单、箱单的快速创建入口
- **最近文档**: 显示最近编辑的文档，支持快速访问
- **实用工具**: 集成AI邮件助手、日期计算等工具
- **管理功能**: 快速访问单据管理和客户管理
- **权限控制**: 根据用户权限动态显示可用功能
- **性能优化**: 使用缓存机制和预加载提升用户体验

#### Dashboard详细使用说明
- **页面布局**: 顶部导航栏、功能按钮区域、最近单据区域
- **功能按钮**: 分为快速创建单据、管理中心、实用工具三个类别
- **时间筛选**: 支持1天、3天、1周、1个月的时间范围筛选
- **权限控制**: 根据用户权限动态显示功能，无权限时显示友好提示
- **实时更新**: 单据创建或修改后自动更新列表，支持跨标签页同步
- **响应式设计**: 完美支持移动端和暗色模式

详细使用说明请参考：[Dashboard使用说明](./DASHBOARD_USAGE_GUIDE.md)

### 2. 单据管理中心 (History Management)
- **权限控制**: 根据用户在tools页面的权限设置，动态显示可访问的选项卡
- **多类型支持**: 支持报价单、合同确认、采购单、装箱单、发票等历史记录管理
- **高级过滤**: 支持按时间、金额、类型等多维度过滤
- **批量操作**: 支持批量删除、导出、导入功能
- **实时搜索**: 支持客户名称、单据编号等快速搜索

#### 权限控制机制
- 系统会根据用户在tools页面的权限设置，自动显示/隐藏对应的选项卡
- 权限映射关系：
  - `quotation` 权限 → 显示"报价单"和"合同确认"选项卡
  - `invoice` 权限 → 显示"发票"选项卡
  - `purchase` 权限 → 显示"采购单"选项卡
  - `packing` 权限 → 显示"装箱单"选项卡

#### 功能特性
- **智能切换**: 如果当前选项卡没有权限，会自动切换到第一个有权限的选项卡
- **权限验证**: 所有操作（编辑、删除、预览、复制等）都会验证用户权限
- **无权限提示**: 当用户没有任何权限时，显示友好的提示信息
- **加载状态**: 在获取用户权限时显示加载动画

### 3. 工具页面 (Tools)
- **模块化设计**: 每个功能模块独立，支持权限控制
- **动态加载**: 根据用户权限动态显示可用工具
- **性能优化**: 使用缓存机制提升加载速度

### 4. 单据生成功能
- **报价单**: 支持报价单和销售确认单的生成
- **采购单**: 完整的采购订单管理
- **发票**: 专业的发票生成和管理
- **装箱单**: 详细的装箱单和发票生成

## 技术架构

### 前端技术栈
- **Next.js 14**: 使用App Router架构
- **React 18**: 最新的React特性
- **TypeScript**: 完整的类型安全
- **Tailwind CSS**: 现代化的样式系统
- **Lucide React**: 图标库

### 后端技术栈
- **Next.js API Routes**: 服务端API
- **Prisma**: 数据库ORM
- **NextAuth.js**: 身份认证
- **PostgreSQL**: 数据库

### 性能优化
- **动态导入**: 使用dynamic import减少初始包大小
- **缓存机制**: 用户信息和权限缓存
- **懒加载**: 组件和资源的懒加载
- **性能监控**: 内置性能监控和优化
- **权限优化**: 智能权限加载，避免重复刷新
- **退出优化**: 优化退出登录流程，避免重复操作

## 权限系统

### 权限模型
```typescript
interface Permission {
  id: string;
  moduleId: string;
  canAccess: boolean;
}

interface User {
  id: string;
  username: string;
  email: string | null;
  status: boolean;
  isAdmin: boolean;
  permissions: Permission[];
}
```

### 权限管理系统
- **全局状态管理**: 使用 Zustand 进行权限状态管理
- **智能缓存**: 15分钟权限缓存，减少重复请求
- **权限守卫**: 提供 PermissionGuard 组件保护页面
- **权限检查**: 提供便捷的权限检查Hook

### 权限控制流程
1. **用户登录**: 获取用户信息和权限
2. **权限缓存**: 权限信息缓存15分钟，避免重复验证
3. **动态显示**: 根据权限动态显示/隐藏功能
4. **页面保护**: 使用 PermissionGuard 保护需要权限的页面
5. **实时更新**: 权限变更时自动更新界面

## 开发指南

### 环境设置
```bash
# 安装依赖
npm install

# 设置环境变量
cp .env.example .env.local

# 运行开发服务器
npm run dev
```

### 数据库设置
```bash
# 运行数据库迁移
npx prisma migrate dev

# 生成Prisma客户端
npx prisma generate
```

### 权限管理
- 通过管理员界面为用户分配权限
- 权限变更会实时反映在界面上
- 支持细粒度的模块权限控制

## 部署

### 生产环境
- 使用Vercel进行部署
- 配置环境变量
- 设置数据库连接

### 性能优化
- 启用CDN加速
- 配置缓存策略
- 监控应用性能

## 更新日志

### v1.0.0
- 实现基础的单据管理功能
- 添加权限控制系统
- 优化用户界面和用户体验
- 完善错误处理和日志记录

## 贡献指南

欢迎提交Issue和Pull Request来改进这个项目。

## 许可证

MIT License
