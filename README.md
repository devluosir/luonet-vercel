# MLUONET - 企业管理系统

一个现代化的企业管理系统，提供报价、采购、发票、箱单等完整的业务流程管理功能。

## 🚀 最新性能优化 (2025-07-18)

### 性能提升成果
- **数据库查询速度**: 从5-6秒降低到< 1000ms
- **页面加载时间**: 大部分页面编译时间控制在1-2秒内
- **API响应时间**: 会话验证从2-3秒降低到50-300ms
- **缓存命中率**: 用户信息缓存时间增加到10分钟

### 核心优化措施

#### 1. 数据库优化
- ✅ 添加了复合索引优化权限查询
- ✅ 优化连接池配置（最大20连接，最小3连接）
- ✅ 实现智能缓存策略（10分钟缓存）
- ✅ 添加慢查询监控和报警

#### 2. API性能优化
- ✅ 优化用户权限查询结构
- ✅ 添加ETag支持减少网络传输
- ✅ 实现重试机制（最多2次重试）
- ✅ 添加性能监控和统计

#### 3. 前端优化
- ✅ 分阶段页面预加载策略
- ✅ 动态组件加载减少初始包大小
- ✅ 优化资源加载和缓存策略
- ✅ 实现性能指标收集

#### 4. 系统配置优化
- ✅ 启用Next.js Turbo模式
- ✅ 优化中间件处理逻辑
- ✅ 减少不必要的日志输出
- ✅ 优化数据库连接健康检查频率

## 📊 性能监控

系统集成了完整的性能监控工具：

```bash
# 查看数据库状态
curl http://localhost:3000/api/debug

# 运行性能测试
node scripts/performance-test.js
```

### 监控指标
- 数据库连接状态和响应时间
- 慢查询检测和统计
- API调用性能分析
- 页面加载时间监控

## 🛠️ 技术栈

- **前端**: Next.js 14, React 18, TypeScript
- **后端**: Next.js API Routes, Prisma ORM
- **数据库**: PostgreSQL (Neon)
- **认证**: NextAuth.js
- **样式**: Tailwind CSS
- **部署**: Vercel

## 📦 安装和运行

1. **克隆项目**
```bash
git clone <repository-url>
cd mluonet
```

2. **安装依赖**
```bash
npm install
```

3. **环境配置**
```bash
cp .env.example .env.local
```

编辑 `.env.local` 文件，配置以下环境变量：
```env
# 数据库配置
DATABASE_URL="postgresql://username:password@localhost:5432/mluonet"
DIRECT_URL="postgresql://username:password@localhost:5432/mluonet"

# NextAuth配置
NEXTAUTH_SECRET="your-secret-key"
NEXTAUTH_URL="http://localhost:3000"

# AI服务配置
DEEPSEEK_API_KEY="your-deepseek-api-key"
```

4. **数据库迁移**
```bash
npx prisma migrate dev
npx prisma generate
```

5. **启动开发服务器**
```bash
npm run dev
```

访问 http://localhost:3000 开始使用

## 🔧 性能优化说明

### 已实施的优化措施

1. **缓存策略优化**
   - 用户信息缓存时间从1分钟增加到10分钟
   - 添加缓存过期检查和自动清理
   - 实现智能缓存工具函数

2. **API调用优化**
   - 添加重试机制（最多重试2次）
   - 优化数据库查询，只获取必要字段
   - 添加ETag支持，减少不必要的网络传输

3. **页面加载优化**
   - 分阶段预加载页面，避免资源竞争
   - 优先加载常用页面（quotation, invoice）
   - 延迟加载次要页面（purchase, history）

4. **中间件优化**
   - 跳过静态资源的中间件处理
   - 减少不必要的token验证

5. **性能监控**
   - 实时监控API调用性能
   - 监控资源加载时间
   - 开发环境下输出详细性能指标

### 性能监控工具

系统集成了性能监控工具，在开发环境下会自动输出：
- 页面加载时间
- API调用耗时
- 慢资源加载警告
- 用户信息获取时间

## 🚨 故障排除

### 常见问题

1. **页面加载缓慢**
   - 检查网络连接
   - 查看浏览器控制台的性能警告
   - 确认数据库连接正常

2. **API调用失败**
   - 检查用户登录状态
   - 确认API路由配置正确
   - 查看服务器日志

3. **权限问题**
   - 确认用户权限配置
   - 检查模块权限设置
   - 联系管理员分配权限

### 性能问题诊断

1. **数据库连接问题**
   ```bash
   # 检查数据库连接
   curl http://localhost:3000/api/debug
   ```

2. **慢查询分析**
   - 查看控制台输出的慢查询警告
   - 使用数据库监控工具分析查询性能

3. **缓存问题**
   - 检查浏览器缓存设置
   - 确认API缓存头配置正确

## 📈 性能基准

### 目标性能指标
- **页面首次加载**: < 3秒
- **API响应时间**: < 1秒
- **数据库查询**: < 500ms
- **页面切换**: < 1秒

### 当前性能状态
- ✅ 数据库连接: 健康状态
- ✅ 连接池: 活跃状态
- ✅ 慢查询: 0个
- 🟡 部分页面编译: 需要进一步优化

## 🔄 持续优化

系统将持续监控和优化性能：

1. **定期性能检查**
   - 每周运行性能测试
   - 监控生产环境性能指标

2. **用户反馈收集**
   - 收集用户使用体验反馈
   - 根据反馈调整优化策略

3. **技术栈更新**
   - 及时更新依赖包
   - 采用新的性能优化技术

## 📞 支持

如有问题或建议，请联系开发团队。
