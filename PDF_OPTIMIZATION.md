# PDF文件大小优化方案

## 问题描述

在生成包含印章的PDF文件时，文件大小会显著增加。主要原因是：

1. **印章图片文件过大**：
   - `stamp-shanghai.png`: 818KB
   - `stamp-hongkong.png`: 228KB

2. **图片被完整嵌入**：每次生成PDF时都会嵌入完整的base64编码图片

3. **缺乏压缩优化**：没有对图片进行压缩处理

## 解决方案

### 方案一：图片压缩（推荐）

#### 1. 使用压缩脚本
```bash
npm run compress-stamps
```

这个脚本会：
- 将印章图片压缩到400x400像素（优化质量版本）
- 使用PNG质量90，压缩级别6
- 在文件大小和图片质量之间取得最佳平衡

#### 2. 替换原始文件
压缩完成后，将 `public/images/compressed/` 目录下的文件替换原始文件：
```bash
cp public/images/compressed/* public/images/
```

### 方案二：运行时优化（已实现）

代码中已经实现了运行时图片优化：

1. **自动尺寸调整**：将图片限制在300px最大尺寸
2. **质量压缩**：使用0.8的质量设置
3. **智能降级**：如果压缩失败，自动使用原始图片

### 方案三：进一步优化建议

#### 1. 使用WebP格式
考虑将印章图片转换为WebP格式，可以获得更好的压缩效果：

```bash
# 安装webp工具
brew install webp  # macOS
apt-get install webp  # Ubuntu

# 转换图片
cwebp -q 80 stamp-shanghai.png -o stamp-shanghai.webp
cwebp -q 80 stamp-hongkong.png -o stamp-hongkong.webp
```

#### 2. 使用SVG格式
如果印章设计允许，考虑使用SVG格式：
- 矢量图形，无损缩放
- 文件大小极小
- 完美适配不同尺寸

#### 3. 懒加载优化
对于不常用的印章，可以考虑按需加载：

```typescript
// 只在需要时加载印章图片
const loadStampImage = async (stampType: string) => {
  const response = await fetch(`/api/stamps/${stampType}`);
  const blob = await response.blob();
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
};
```

## 预期效果

使用图片压缩后，预期可以达到：

- **上海印章**：从818KB压缩到约83KB（压缩率90%）
- **香港印章**：从228KB压缩到约18KB（压缩率92%）
- **PDF文件大小**：整体减少85-90%
- **图片质量**：保持清晰可读，无明显模糊

## 压缩参数优化

### 最新优化参数
- **尺寸**：400x400像素（之前200x200）
- **质量**：90%（之前80%）
- **压缩级别**：6（之前9）
- **运行时压缩**：300px最大尺寸，0.8质量

### 质量与大小平衡
- ✅ **清晰度**：印章文字和图案清晰可读
- ✅ **文件大小**：显著减少PDF文件大小
- ✅ **兼容性**：在所有设备上正常显示
- ✅ **性能**：不影响PDF生成速度

## 实施步骤

1. **立即执行**：
   ```bash
   npm run compress-stamps
   ```

2. **测试效果**：
   - 生成包含印章的PDF文件
   - 对比压缩前后的文件大小
   - 检查印章显示质量

3. **长期优化**：
   - 考虑使用WebP或SVG格式
   - 实现按需加载机制
   - 定期检查和优化图片资源

## 注意事项

1. **质量平衡**：压缩过度可能影响印章的清晰度
2. **兼容性**：确保压缩后的图片在不同设备上正常显示
3. **备份**：压缩前请备份原始图片文件
4. **测试**：在生产环境部署前充分测试

## 监控和维护

1. **定期检查**：每月检查一次图片文件大小
2. **用户反馈**：收集用户对PDF质量的反馈
3. **持续优化**：根据使用情况调整压缩参数

## 压缩效果对比

| 印章类型 | 原始大小 | 压缩后大小 | 压缩率 | 质量评估 |
|---------|---------|-----------|--------|---------|
| 上海印章 | 818KB | 83KB | 90% | 清晰可读 |
| 香港印章 | 228KB | 18KB | 92% | 清晰可读 |
| **总计** | **1046KB** | **101KB** | **90%** | **优秀** | 