# 权限调试记录

## 问题描述
1. 初次登录时，权限正确显示
2. 修改权限后，页面刷新无法获取新权限
3. 清空浏览器缓存后重新登录，权限正确显示
4. 权限刷新功能不稳定

## 根本原因
NextAuth的session缓存问题：
- 初次登录时，从数据库获取最新权限
- 修改权限后，session仍然使用缓存数据
- 清空缓存后重新登录，重新从数据库获取权限

## 调试步骤

### 1. 检查session状态
```javascript
// 在dashboard页面添加调试信息
console.log('Session状态:', {
  hasSession: !!session,
  sessionUser: session?.user?.name,
  sessionStatus: status
});
console.log('Session用户权限:', session?.user?.permissions);
```

### 2. 检查权限store状态
```javascript
// 在permissions.ts中添加调试信息
console.log('获取用户权限成功:', {
  username: userData.username,
  permissions: userData.permissions,
  isAdmin: userData.isAdmin
});
```

### 3. 检查权限映射
```javascript
// 在dashboard页面检查权限映射
console.log('权限映射更新:', {
  user: user?.username,
  userPermissions: user?.permissions,
  permissions: permissionMap,
  documentTypePermissions: permissionMap.documentTypePermissions,
  accessibleDocumentTypes: permissionMap.accessibleDocumentTypes
});
```

## 解决方案

### 方案1：强制重新登录（推荐）
```javascript
// 权限刷新时强制重新登录
await signOut({ redirect: false });
setTimeout(async () => {
  await signIn('credentials', {
    username: session?.user?.username,
    password: 'dummy',
    redirect: false
  });
  await fetchUser();
}, 1000);
```

### 方案2：直接从数据库获取权限
```javascript
// 创建专门的API端点获取最新权限
const response = await fetch('/api/auth/get-latest-permissions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' }
});
```

### 方案3：清除session缓存
```javascript
// 强制刷新session
const response = await fetch('/api/auth/session', {
  headers: {
    'Cache-Control': 'no-cache',
    'Pragma': 'no-cache'
  }
});
```

## 关键调试点

### 1. Session加载状态
- `status === 'loading'` - session正在加载
- `status === 'authenticated'` - 已认证
- `status === 'unauthenticated'` - 未认证

### 2. 权限数据格式
- 字符串数组：`['quotation', 'packing']`
- 对象数组：`[{moduleId: 'quotation', canAccess: true}]`
- 对象格式：`{quotation: true, packing: false}`

### 3. 权限检查逻辑
```javascript
hasPermission: (moduleId: string) => {
  const { user } = get();
  if (!user?.permissions) return false;
  
  const permission = user.permissions.find(p => p.moduleId === moduleId);
  return permission?.canAccess || false;
}
```

## 测试步骤

### 1. 基础测试
1. 清空浏览器缓存
2. 登录用户
3. 检查权限是否正确显示

### 2. 权限修改测试
1. 在后台修改用户权限
2. 回到dashboard页面
3. 点击刷新权限按钮
4. 检查是否获取到新权限

### 3. 页面刷新测试
1. 修改权限后
2. 刷新dashboard页面
3. 检查权限是否更新

## 常见问题

### 1. 500错误
- 检查API端点是否正确
- 检查数据库连接
- 检查环境变量

### 2. 401错误
- 检查session状态
- 检查用户是否已登录

### 3. 权限不更新
- 检查session缓存
- 检查权限数据格式
- 检查权限映射逻辑

## 性能问题分析

### 当前存在的性能问题
1. **登录时间过长** - `login_request: 2428.80ms`
2. **Dashboard加载慢** - `dashboard_page_load: 3203.30ms`
3. **多次权限映射更新** - 重复计算权限映射
4. **Session回调性能** - 每次都从数据库获取权限

### 性能优化方案
1. **减少API调用** - 合并权限获取请求
2. **缓存优化** - 适当的权限缓存机制
3. **减少重复计算** - 优化权限映射逻辑
4. **异步加载** - 权限数据异步获取

## 最佳实践

1. **简化权限系统** - 避免复杂的缓存逻辑
2. **直接获取数据** - 优先从数据库获取最新数据
3. **强制刷新** - 必要时强制重新登录
4. **调试信息** - 保留关键调试信息
5. **错误处理** - 完善的错误处理机制
6. **性能监控** - 监控权限获取性能
7. **合理缓存** - 平衡实时性和性能

## 当前状态总结

### ✅ 已解决的问题
- 权限刷新功能正常工作
- 修改权限后可以正确刷新
- NextAuth session回调获取最新权限

### ⚠️ 需要优化的问题
- 登录和页面加载性能需要优化
- 减少重复的权限映射计算
- 优化session回调中的数据库查询

### 🎯 建议的改进方向
1. 只在必要时才从数据库获取权限
2. 添加适当的权限数据缓存
3. 优化权限映射计算逻辑
4. 减少不必要的重复调用 